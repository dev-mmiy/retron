# 動作確認までの道のり

## 現在の状況（2024-11-09）

### ✅ 完了していること
1. **カーネルビルド**: `kernel-ram.sys` (288KB) が正常にビルドできている
2. **リンカスクリプト**: エントリーポイント `_start` が `0x40200000` に設定されている
3. **UARTドライバ**: `uart_pl011.c` が実装済み
4. **UART初期化**: `devinit.c` で `uart_pl011_init()` が呼ばれる
5. **出力コード**: `usermain_retron.c` で `uart_pl011_putchar()` を直接呼んでいる
6. **QEMU起動スクリプト**: `run-tkernel-qemu.sh` と `run-tkernel-qemu-nogdb.sh` が作成済み

### 🔵 問題点
1. **QEMUでカーネルが実行されていない可能性**
   - `-device loader` でELFをロードしても、エントリーポイントに自動的にジャンプしない
   - QEMUはELFをメモリにロードするだけで、実行を開始しない可能性がある

2. **エントリーポイントの確認が必要**
   - `_start` シンボルが正しく定義されているか
   - `_start` から `main()` への呼び出しが正しく実装されているか

3. **UART初期化のタイミング**
   - `devinit.c` の `init_device()` が呼ばれるタイミングを確認
   - UART初期化前に出力しようとしていないか

## 動作確認までのステップ

### ステップ1: エントリーポイントの確認（優先度: 最高）
**目的**: カーネルが正しく起動できるか確認

**必要な作業**:
1. `_start` シンボルの存在確認
2. `_start` から `main()` への呼び出し確認
3. 必要に応じて `_start` の実装を追加

**確認方法**:
```bash
nm kernel-ram.sys | grep _start
objdump -d kernel-ram.sys | grep -A 20 "_start"
```

**見積もり**: 30分〜1時間

### ステップ2: GDBでの動作確認（優先度: 最高）
**目的**: カーネルが実際に実行されているか確認

**必要な作業**:
1. GDBでQEMUに接続
2. `_start` または `main` にブレークポイントを設定
3. 実行を開始して、ブレークポイントで停止するか確認
4. レジスタとメモリの状態を確認

**確認方法**:
```bash
# QEMUを起動（GDBサーバー有効）
./run-tkernel-qemu.sh

# 別ターミナルでGDBに接続
aarch64-linux-gnu-gdb kernel-ram.sys
(gdb) target remote :1234
(gdb) break _start
(gdb) break main
(gdb) continue
```

**見積もり**: 1〜2時間

### ステップ3: UART初期化の確認（優先度: 高）
**目的**: UARTが正しく初期化されているか確認

**必要な作業**:
1. `devinit.c` の `init_device()` が呼ばれるタイミングを確認
2. `uart_pl011_init()` が正しく実行されているか確認
3. UARTレジスタの状態を確認

**確認方法**:
- GDBで `uart_pl011_init()` にブレークポイントを設定
- UARTレジスタ（0x09000000）の値を確認

**見積もり**: 30分〜1時間

### ステップ4: 最小限の出力テスト（優先度: 高）
**目的**: UARTから文字を出力できるか確認

**必要な作業**:
1. `usermain_retron.c` の `put_string()` が呼ばれるか確認
2. `uart_pl011_putchar()` が正しく動作するか確認
3. QEMUのシリアル出力に文字が表示されるか確認

**確認方法**:
- GDBで `uart_pl011_putchar()` にブレークポイントを設定
- UARTレジスタの状態を確認
- QEMUの `-serial stdio` で出力を確認

**見積もり**: 30分〜1時間

### ステップ5: ブートローダーの検討（優先度: 中）
**目的**: QEMUでカーネルを正しく起動する

**必要な作業**:
1. 必要に応じて最小限のブートローダーを実装
2. または、QEMUの `-kernel` オプションの使用方法を検討
3. または、`-device loader` の動作を確認・修正

**見積もり**: 2〜4時間

## 動作確認ができるようになる時期の見積もり

### 最良のケース（すべてが順調に進む場合）
- **ステップ1〜4**: 3〜5時間
- **動作確認可能**: 今日中（2024-11-09）

### 通常のケース（いくつかの問題が見つかる場合）
- **ステップ1〜4**: 1〜2日
- **動作確認可能**: 明日〜明後日（2024-11-10〜11）

### 最悪のケース（大きな問題が見つかる場合）
- **ステップ1〜5**: 3〜5日
- **動作確認可能**: 今週末（2024-11-12〜13）

## 次のアクション

1. **今すぐ実行**: ステップ1（エントリーポイントの確認）
2. **次に実行**: ステップ2（GDBでの動作確認）
3. **問題が見つかった場合**: ステップ5（ブートローダーの検討）

## 注意事項

- QEMUの `-device loader` はELFファイルをメモリにロードするだけで、実行を開始しない可能性がある
- ARM AArch64では、リセットベクターが `0x0` または `0x8000` に設定されることが多い
- QEMU virt machineでは、リセットベクターが `0x0` に設定される可能性がある
- 必要に応じて、最小限のブートローダーを実装する必要がある


