# UARTメモリ書き込み問題

## 問題

GDBで`set *(volatile unsigned int*)0x09000030 = 0x301`を実行しても、読み戻すと0x300のままです。

## 考えられる原因

### 1. データキャッシュの問題

ARM AArch64では、デバイスメモリ（UARTレジスタ）は通常、キャッシュを無効化する必要があります。
現在、データキャッシュは有効（`cpu_init.c`で`C bit = 1`）になっています。

**解決方法**: デバイスメモリへのアクセス時にキャッシュを無効化するか、キャッシュフラッシュを実行する必要があります。

### 2. メモリアトリビュートの問題

ARM AArch64では、デバイスメモリには適切なメモリアトリビュート（Device-nGnREなど）を設定する必要があります。
現在、メモリアトリビュートの設定が不明です。

**解決方法**: メモリアトリビュートを確認し、必要に応じて設定する必要があります。

### 3. QEMUのメモリマッピング

QEMUのメモリマッピングが正しく設定されていない可能性があります。

**解決方法**: QEMUの設定を確認し、必要に応じて修正する必要があります。

## 確認手順

### ステップ1: メモリマッピングを確認

```gdb
(gdb) x/16x 0x09000000
```

### ステップ2: 別のアドレスに書き込んでテスト

```gdb
(gdb) set *(volatile unsigned int*)0x40200000 = 0x12345678
(gdb) print/x *(volatile unsigned int*)0x40200000
```

### ステップ3: UARTレジスタの読み取りを確認

```gdb
(gdb) print/x *(volatile unsigned int*)0x09000000
(gdb) print/x *(volatile unsigned int*)0x09000004
(gdb) print/x *(volatile unsigned int*)0x09000018
(gdb) print/x *(volatile unsigned int*)0x09000030
```

## 解決方法

### 方法1: キャッシュを無効化

`uart_pl011.c`の`uart_write_reg`関数で、キャッシュを無効化するか、キャッシュフラッシュを実行する必要があります。

### 方法2: メモリアトリビュートを設定

ARM AArch64では、デバイスメモリには適切なメモリアトリビュートを設定する必要があります。
ただし、MMUが無効な場合、メモリアトリビュートの設定は限定的です。

### 方法3: QEMUの設定を確認

QEMUのメモリマッピングが正しく設定されているか確認する必要があります。

## 次のステップ

1. メモリマッピングを確認
2. 別のアドレスに書き込んでテスト
3. UARTレジスタの読み取りを確認
4. キャッシュを無効化するか、キャッシュフラッシュを実行
