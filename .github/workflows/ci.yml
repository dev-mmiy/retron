name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  RUST_BACKTRACE: 1
  RUSTFLAGS: -D warnings  # è­¦å‘Šã‚’ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦æ‰±ã†

jobs:
  # ==========================================
  # Job 1: ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
  # ==========================================
  format:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check

  # ==========================================
  # Job 2: Clippyãƒªãƒ³ãƒˆãƒã‚§ãƒƒã‚¯
  # ==========================================
  clippy:
    name: Clippy Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: clippy

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            kernel/target
          key: ${{ runner.os }}-cargo-clippy-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-clippy-
            ${{ runner.os }}-cargo-

      - name: Run clippy
        run: |
          cd kernel
          cargo clippy --all-targets -- -D warnings

  # ==========================================
  # Job 3: ãƒ“ãƒ«ãƒ‰æ¤œè¨¼ï¼ˆè­¦å‘Šã‚¼ãƒ­ãƒã‚§ãƒƒã‚¯ï¼‰
  # ==========================================
  build:
    name: Build & Zero Warnings Check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        profile: [debug, release]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@nightly
        with:
          targets: x86_64-unknown-none

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            kernel/target
          key: ${{ runner.os }}-cargo-${{ matrix.profile }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.profile }}-
            ${{ runner.os }}-cargo-

      - name: Build (${{ matrix.profile }})
        run: |
          cd kernel
          if [ "${{ matrix.profile }}" = "release" ]; then
            cargo build --release 2>&1 | tee build.log
          else
            cargo build 2>&1 | tee build.log
          fi

      - name: Check for warnings
        run: |
          if grep -i "warning:" kernel/build.log; then
            echo "âŒ Warnings detected! Build must be warning-free."
            exit 1
          else
            echo "âœ… Zero warnings - build is clean!"
          fi

      - name: Upload build artifacts
        if: matrix.profile == 'release'
        uses: actions/upload-artifact@v3
        with:
          name: retron-kernel-${{ matrix.profile }}
          path: kernel/target/x86_64-unknown-none/${{ matrix.profile }}/retron-kernel
          retention-days: 7

  # ==========================================
  # Job 4: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
  # ==========================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@nightly

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Run security audit
        run: |
          cd kernel
          cargo audit

  # ==========================================
  # Job 5: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆãƒã‚§ãƒƒã‚¯
  # ==========================================
  docs:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@nightly

      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            kernel/target
          key: ${{ runner.os }}-cargo-docs-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-docs-
            ${{ runner.os }}-cargo-

      - name: Generate documentation
        run: |
          cd kernel
          cargo doc --no-deps --document-private-items

      - name: Check for broken links
        run: |
          echo "ğŸ“š Documentation generated successfully"

  # ==========================================
  # Job 6: ã‚³ãƒ¼ãƒ‰å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹
  # ==========================================
  metrics:
    name: Code Quality Metrics
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Count lines of code
        run: |
          echo "ğŸ“Š Lines of Code Statistics"
          echo "=============================="
          total_lines=$(find kernel/src -name "*.rs" -exec cat {} \; | wc -l)
          file_count=$(find kernel/src -name "*.rs" | wc -l)
          echo "Total files: $file_count"
          echo "Total lines: $total_lines"
          echo "Average lines per file: $((total_lines / file_count))"

      - name: Check TODO comments
        run: |
          echo ""
          echo "ğŸ“ TODO Comments"
          echo "================"
          todo_count=$(grep -r "TODO" kernel/src 2>/dev/null | wc -l || echo "0")
          echo "TODO count: $todo_count"
          if [ $todo_count -gt 0 ]; then
            grep -rn "TODO" kernel/src || true
          fi

      - name: Check FIXME comments
        run: |
          echo ""
          echo "âš ï¸  FIXME Comments"
          echo "=================="
          fixme_count=$(grep -r "FIXME" kernel/src 2>/dev/null | wc -l || echo "0")
          if [ $fixme_count -gt 0 ]; then
            echo "Warning: $fixme_count FIXME comments found"
            grep -rn "FIXME" kernel/src || true
            exit 1
          else
            echo "âœ… No FIXME comments found"
          fi

  # ==========================================
  # Job 7: æœ€çµ‚ç¢ºèªï¼ˆå…¨ã‚¸ãƒ§ãƒ–æˆåŠŸå¾Œï¼‰
  # ==========================================
  final-check:
    name: Final Verification
    needs: [format, clippy, build, security, docs, metrics]
    runs-on: ubuntu-latest
    steps:
      - name: All checks passed
        run: |
          echo "âœ… All CI/CD checks passed!"
          echo "ğŸ‰ Code quality verified!"
          echo "ğŸ“¦ Ready to merge!"
          echo ""
          echo "Quality Gates Passed:"
          echo "  âœ… Code formatting"
          echo "  âœ… Linting (Clippy)"
          echo "  âœ… Build (debug & release)"
          echo "  âœ… Zero warnings policy"
          echo "  âœ… Security audit"
          echo "  âœ… Documentation"
          echo "  âœ… Code metrics"
